# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "generic/freebsd12"

  config.nfs.verify_installed = false
  config.vm.synced_folder '.', '/vagrant', disabled: true
  config.ssh.forward_agent = true

  config.vm.provision "shell", inline: <<-SHELL
    pkg install -y gmake ccache git flex bison readline
  SHELL

  # get a source tree and some scripts to start things off
  $setup_tree = <<-SHELL
    git clone https://github.com/postgres/postgres.git
    cd postgres
    echo './configure --prefix=$HOME/install --enable-cassert --enable-debug --with-libs=/usr/local/lib --with-includes=/usr/local/include CC="ccache cc"' > reconfigure.sh
    echo 'gmake -s clean && gmake -s -j4 && gmake -s install && gmake -s check' > rebuild.sh
    chmod +x reconfigure.sh rebuild.sh
  SHELL
  config.vm.provision "shell", inline: $setup_tree, privileged: false

  config.vm.provider :libvirt do |domain|
    domain.memory = 4096
    domain.cpus = 4
  end
end

